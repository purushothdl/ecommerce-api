
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Commerce Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        input, button, select { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { background: #007cba; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #card-element { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        pre { background-color: #f0f0f0; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .cart-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>E-Commerce Test Flow</h1>

    <!-- Step 1: Login -->
    <div class="section">
        <h2>1. Login</h2>
        <input type="email" id="email" value="admin@example.com" placeholder="Email">
        <input type="password" id="password" value="supersecretpassword" placeholder="Password">
        <button id="loginBtn">Login</button>
        <pre id="login-response"></pre>
    </div>

    <!-- Step 2: Add Items to Cart -->
    <div class="section">
        <h2>2. Add Items to Cart</h2>
        <input type="number" id="productId" value="1" placeholder="Product ID">
        <input type="number" id="quantity" value="2" placeholder="Quantity">
        <button id="addToCartBtn" disabled>Add to Cart</button>
        <button id="getCartBtn" disabled>Get Cart</button>
        <pre id="cart-response"></pre>
    </div>

    <!-- Step 3: Create Addresses -->
    <div class="section">
        <h2>3. Create Address (Optional)</h2>
        <input type="text" id="addressName" value="John Doe" placeholder="Name">
        <input type="text" id="addressPhone" value="1234567890" placeholder="Phone">
        <input type="text" id="addressStreet" value="123 Main St" placeholder="Street">
        <input type="text" id="addressCity" value="New York" placeholder="City">
        <input type="text" id="addressState" value="NY" placeholder="State">
        <input type="text" id="addressPostal" value="10001" placeholder="Postal Code">
        <input type="text" id="addressCountry" value="US" placeholder="Country">
        <button id="createAddressBtn" disabled>Create Address</button>
        <pre id="address-response"></pre>
    </div>

    <!-- Step 4: Create Order -->
    <div class="section">
        <h2>4. Create Order</h2>
        <label>
            <input type="radio" name="addressType" value="inline" checked> Use Inline Address
        </label>
        <label>
            <input type="radio" name="addressType" value="saved"> Use Saved Address ID
        </label>
        <input type="number" id="savedAddressId" placeholder="Address ID (if using saved)" disabled>
        <button id="createOrderBtn" disabled>Create Order & Get Payment Intent</button>
        <pre id="order-response"></pre>
    </div>

    <!-- Step 5: Payment -->
    <div class="section">
        <h2>5. Complete Payment</h2>
        <div id="card-element"></div>
        <button id="payBtn" disabled>Pay Now</button>
        <pre id="payment-response"></pre>
    </div>
</div>

<script>
    // Use your Stripe publishable key
    const stripe = Stripe('pk_test_51Rnkq5R46uEaqwG6CtNpRugqjJ76lEcxlqcUU8n4v1cepDUbcWFYrC73gnAjPVx2xwzzleFsNx8MjxcdNiESvscX00DmRepAcZ'); 


    const backendUrl = ''; // Same origin since we're serving from Go

    // DOM elements
    const loginBtn = document.getElementById('loginBtn');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const getCartBtn = document.getElementById('getCartBtn');
    const createAddressBtn = document.getElementById('createAddressBtn');
    const createOrderBtn = document.getElementById('createOrderBtn');
    const payBtn = document.getElementById('payBtn');

    const loginResponseEl = document.getElementById('login-response');
    const cartResponseEl = document.getElementById('cart-response');
    const addressResponseEl = document.getElementById('address-response');
    const orderResponseEl = document.getElementById('order-response');
    const paymentResponseEl = document.getElementById('payment-response');

    let jwtToken = '';
    let clientSecret = '';
    let createdAddressId = null;

    // Stripe Elements
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    // Address type toggle
    document.querySelectorAll('input[name="addressType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            document.getElementById('savedAddressId').disabled = e.target.value === 'inline';
        });
    });

    // Step 1: Login
    loginBtn.addEventListener('click', async () => {
        try {
            const res = await fetch(`/api/v1/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: document.getElementById('email').value, 
                    password: document.getElementById('password').value 
                })
            });
            
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Login failed');
            
            jwtToken = data.data.access_token;
            loginResponseEl.textContent = `‚úÖ Login Success! Token: ${jwtToken.substring(0, 30)}...`;
            
            // Enable next steps
            addToCartBtn.disabled = false;
            getCartBtn.disabled = false;
            createAddressBtn.disabled = false;
        } catch (error) {
            loginResponseEl.textContent = `‚ùå Error: ${error.message}`;
        }
    });

    // Step 2a: Add to Cart
    addToCartBtn.addEventListener('click', async () => {
        try {
            const res = await fetch(`/api/v1/cart/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({
                    product_id: parseInt(document.getElementById('productId').value),
                    quantity: parseInt(document.getElementById('quantity').value)
                })
            });
            
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Failed to add to cart');
            
            cartResponseEl.textContent = `‚úÖ Added to cart! Total items: ${data.data.total_items}`;
            createOrderBtn.disabled = false;
        } catch (error) {
            cartResponseEl.textContent = `‚ùå Error: ${error.message}`;
        }
    });

    // Step 2b: Get Cart
    // Add this helper function at the top of your script
    let cartItems = [];

    // Update the Get Cart function to store items
    getCartBtn.addEventListener('click', async () => {
        try {
            const res = await fetch(`/api/v1/cart`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });
            
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Failed to get cart');
            
            // Store cart items for order creation
            cartItems = data.data.items || [];
            
            cartResponseEl.textContent = `Cart Contents:\n${JSON.stringify(data.data, null, 2)}`;
            
            // Enable order creation if cart has items
            if (cartItems.length > 0) {
                createOrderBtn.disabled = false;
            }
        } catch (error) {
            cartResponseEl.textContent = `‚ùå Error: ${error.message}`;
        }
    });

    // Updated Create Order function using cart items
    createOrderBtn.addEventListener('click', async () => {
        try {
            if (cartItems.length === 0) {
                throw new Error('No items in cart. Add items first and get cart.');
            }

            const addressType = document.querySelector('input[name="addressType"]:checked').value;
            
            // Convert cart items to order items format
            const items = cartItems.map(item => ({
                product_id: item.product_id,
                quantity: item.quantity
            }));

            let orderData = {
                items: items,
                payment_method: "stripe"
            };

            if (addressType === 'inline') {
                orderData.shipping_address = {
                    name: document.getElementById('addressName').value,
                    phone: document.getElementById('addressPhone').value,
                    street1: document.getElementById('addressStreet').value,
                    city: document.getElementById('addressCity').value,
                    state: document.getElementById('addressState').value,
                    postal_code: document.getElementById('addressPostal').value,
                    country: document.getElementById('addressCountry').value
                };
                orderData.billing_address = orderData.shipping_address;
            } else {
                const addressId = parseInt(document.getElementById('savedAddressId').value);
                orderData.shipping_address_id = addressId;
                orderData.billing_address_id = addressId;
            }

            console.log('Sending order data:', orderData);

            const res = await fetch(`/api/v1/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify(orderData)
            });
            
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Order creation failed');

            clientSecret = data.data.client_secret;
            orderResponseEl.textContent = `‚úÖ Order Created!\nOrder ID: ${data.data.id}\nClient Secret: ${clientSecret}`;
            payBtn.disabled = false;
        } catch (error) {
            orderResponseEl.textContent = `‚ùå Error: ${error.message}`;
            console.error('Order creation error:', error);
        }
    });


    // Step 5: Complete Payment
    payBtn.addEventListener('click', async () => {
        paymentResponseEl.textContent = '‚è≥ Processing payment...';
        
        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: document.getElementById('addressName').value,
                }
            }
        });

        if (error) {
            paymentResponseEl.textContent = `‚ùå Payment failed: ${error.message}`;
        } else {
            paymentResponseEl.textContent = `üéâ Payment successful!\nPayment Intent ID: ${paymentIntent.id}\nStatus: ${paymentIntent.status}`;
        }
    });
</script>

</body>
</html>
