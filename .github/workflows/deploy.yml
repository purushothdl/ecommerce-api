# .github/workflows/deploy.yml
name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  GCP_REGION: asia-south1
  GCP_ARTIFACT_REPO: gokart-server
  GCP_GAR_HOST: asia-south1-docker.pkg.dev

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    strategy:
      matrix:
        service:
          - name: api
            run_service_name: gokart-api
            dockerfile: Dockerfile.api
            paths: |
              cmd/api/**
              internal/**
              configs/**
              events/**
              pkg/**
              go.mod
              go.sum
          - name: mega-worker
            run_service_name: mega-worker
            dockerfile: Dockerfile.mega-worker
            paths: |
              cmd/mega-worker/**
              workers/**
              events/**
              pkg/**
              go.mod
              go.sum

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: 'Get changed files'
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: ${{ matrix.service.paths }}

      - name: Authenticate to Google Cloud
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/138027296220/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v2'
          service_account: '${{ secrets.GCP_SA_EMAIL_FOR_ACTIONS }}'

      # ADD THIS STEP - Configure Docker to authenticate with Artifact Registry
      - name: Configure Docker for Artifact Registry
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          gcloud auth configure-docker ${{ env.GCP_GAR_HOST }} --quiet

      - name: Set up Docker Buildx
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: 'Debug: Print image tags'
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Service Name: ${{ matrix.service.name }}"
          echo "Project ID from Secret: ${{ secrets.GCP_PROJECT_ID }}"
          echo "Full Image Tag: ${{ env.GCP_GAR_HOST }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPO }}/${{ matrix.service.name }}:${{ github.sha }}"

      - name: Build and push Docker image
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ env.GCP_GAR_HOST }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPO }}/${{ matrix.service.name }}:${{ github.sha }}

      - name: Deploy to Cloud Run
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: ${{ matrix.service.run_service_name }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_GAR_HOST }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPO }}/${{ matrix.service.name }}:${{ github.sha }}
